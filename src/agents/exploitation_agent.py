# src/agents/exploitation_agent.py
import json
from rich.console import Console
from rich.panel import Panel
from agents.base_agent import BaseAgent

console = Console()

class ExploitationAgent(BaseAgent):
    def __init__(self, model_name, tool_executor, user_instructions, model_provider="ollama", openrouter_key=None):
        super().__init__(model_name, tool_executor, user_instructions, model_provider, openrouter_key)
        self.system_prompt = f"""
        You are the Exploitation Agent, an autonomous security assessment specialist.
        
        ### CRITICAL: YOU ARE ALONE.
        1.  **JSON ONLY:** Output PURE JSON. Put reasoning in the "thought" field.
        2.  **NO PLACEHOLDERS:** Never use `...` or `path/to/file`. Use the ACTUAL TARGET.
        3.  **SELF-SUFFICIENCY:** If you need a token/nonce, write a Python script to FETCH IT first.
        4.  **ITERATIVE:** Step 1: Recon script. Step 2: Assessment script using data from Step 1.
        5.  **TERMINAL:** You can use `subprocess` in Python to run shell commands if needed.

        ### MISSION: {self.user_instructions}

        ### JSON Structure:
        {{
            "thought": "Reasoning...",
            "vulnerability": "Vulnerability Name",
            "exploit_script": "import requests\\n...",
            "description": "Description...",
            "is_goal_achieved": false
        }}
        """

    def generate_exploit(self, target_url, scanner_report, knowledge_base):
        console.log(f"ExploitationAgent: Strategizing assessment of [bold red]{target_url}[/bold red]")
        
        context_summary = {
            "target": target_url,
            "vulns": scanner_report.get("identified_vulnerabilities", []),
            "last_output": knowledge_base.get("last_exploit_result", "None"),
            "failures_count": len(knowledge_base.get("failures", []))
        }

        messages = [
            {"role": "system", "content": self.system_prompt},
            {"role": "user", "content": f"TARGET: {target_url}\nSTATUS: {json.dumps(context_summary)}. \n\nTASK: Write a Python script to advance the assessment. DO NOT USE PLACEHOLDERS."}
        ]
        return messages, self.system_prompt

    def get_exploit_from_llm(self, messages):
        output = self._chat(messages)
        console.print(Panel(output, title=f"[bold green]Exploitation Strategy Reasoning[/bold green]", border_style="green"))
        
        # Sanitize markdown
        clean_output = output
        if clean_output.strip().startswith("```json"):
            clean_output = clean_output.replace("```json", "").replace("```", "")
            
        extracted = self.extract_json_from_llm_response(clean_output)
        try:
            #if "..." in extracted: raise ValueError("Placeholders detected.")
            return output, extracted, json.loads(extracted, strict=False)
        except Exception as e:
            return output, extracted, {"error": str(e)}
